<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hearts Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: rgba(0, 0, 0, 0.2);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 300;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .connection-status {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .connected {
            background: #4caf50;
        }

        .disconnected {
            background: #f44336;
        }

        .main-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
        }

        .game-area {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 2rem;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            max-width: 1000px;
            width: 100%;
        }

        .lobby-section {
            text-align: center;
        }

        .lobby-title {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            font-weight: 300;
        }

        .lobby-subtitle {
            font-size: 1.2rem;
            margin-bottom: 2rem;
            opacity: 0.8;
        }

        .seats-container {
            display: grid;
            grid-template-areas:
                ".    seat0    ."
                "seat1  .    seat2"
                ".    seat3    .";
            grid-template-columns: 1fr 1fr 1fr;
            grid-template-rows: 1fr 1fr 1fr;
            gap: 2rem;
            margin: 2rem 0;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
            justify-items: center;
            align-items: center;
        }
        .seat {
            /* ...existing code... */
        }
        .seat-upper { grid-area: seat0; }
        .seat-left { grid-area: seat1; }
        .seat-right { grid-area: seat2; }
        .seat-lower { grid-area: seat3; }

        .seat {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            padding: 2rem 1rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .seat:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .seat.occupied {
            background: rgba(76, 175, 80, 0.3);
            border-color: #4caf50;
            cursor: default;
        }

        .seat.my-seat {
            background: rgba(33, 150, 243, 0.3);
            border-color: #2196f3;
        }

        .seat.occupied:hover {
            background: rgba(76, 175, 80, 0.3);
        }

        .seat-number {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
            opacity: 0.7;
        }

        .seat-player {
            font-size: 1.2rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .seat-status {
            font-size: 0.9rem;
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            margin-top: 0.5rem;
        }

        .ready {
            background: #4caf50;
        }

        .not-ready {
            background: #ff9800;
        }

        .empty-seat {
            font-size: 1.1rem;
            opacity: 0.6;
        }

        .lobby-controls {
            margin-top: 2rem;
            display: flex;
            justify-content: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 1rem 2rem;
            border-radius: 30px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn.primary {
            background: #2196f3;
            border-color: #2196f3;
        }

        .btn.primary:hover {
            background: #1976d2;
            border-color: #1976d2;
        }

        .btn.success {
            background: #4caf50;
            border-color: #4caf50;
        }

        .btn.success:hover {
            background: #45a049;
            border-color: #45a049;
        }

        .btn.danger {
            background: #f44336;
            border-color: #f44336;
        }

        .btn.danger:hover {
            background: #da190b;
            border-color: #da190b;
        }

        .error-message {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid #f44336;
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
            text-align: center;
        }

        .success-message {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid #4caf50;
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
            text-align: center;
        }

        .game-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            font-size: 1.1rem;
        }

        .player-count {
            opacity: 0.8;
        }

        @media (max-width: 768px) {
            .header {
                padding: 1rem;
                flex-direction: column;
                gap: 1rem;
            }

            .seats-container {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .seat {
                min-height: 120px;
                padding: 1.5rem 1rem;
            }

            .lobby-controls {
                flex-direction: column;
                align-items: center;
            }

            .btn {
                padding: 0.8rem 1.5rem;
                font-size: 1rem;
            }
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>♥️ Hearts Game</h1>
        <div class="user-info">
            <span id="user-name">Loading...</span>
            <div id="connection-status" class="connection-status disconnected">
                Connecting...
            </div>
        </div>
    </div>

    <div class="main-container">
        <div class="game-area">
            <div id="lobby-section" class="lobby-section">
                <h2 class="lobby-title">Game Lobby</h2>
                <p class="lobby-subtitle">Take a seat and get ready to play Hearts!</p>
                
                <div id="error-container"></div>
                <div id="success-container"></div>

                <div class="game-info">
                    <div class="player-count">
                        Players: <span id="player-count">0</span>/4
                    </div>
                    <div class="lobby-leader">
                        Leader: <span id="lobby-leader">None</span>
                    </div>
                </div>

                <div class="seats-container">
                    <div class="seat seat-upper" data-seat="0" onclick="handleSeatClick(0)">
                        <div class="seat-number">Seat 1</div>
                        <div class="seat-content">
                            <div class="empty-seat">Click to sit</div>
                        </div>
                    </div>
                    <div class="seat seat-left" data-seat="1" onclick="handleSeatClick(1)">
                        <div class="seat-number">Seat 2</div>
                        <div class="seat-content">
                            <div class="empty-seat">Click to sit</div>
                        </div>
                    </div>
                    <div class="seat seat-right" data-seat="2" onclick="handleSeatClick(2)">
                        <div class="seat-number">Seat 3</div>
                        <div class="seat-content">
                            <div class="empty-seat">Click to sit</div>
                        </div>
                    </div>
                    <div class="seat seat-lower" data-seat="3" onclick="handleSeatClick(3)">
                        <div class="seat-number">Seat 4</div>
                        <div class="seat-content">
                            <div class="empty-seat">Click to sit</div>
                        </div>
                    </div>
                </div>

                <div class="lobby-controls">
                    <button id="leave-seat-btn" class="btn danger hidden" onclick="leaveSeat()">
                        Leave Seat
                    </button>
                    <button id="ready-btn" class="btn primary hidden" onclick="toggleReady()">
                        Ready for Game
                    </button>
                    <button id="start-game-btn" class="btn success hidden" onclick="startGame()">
                        Start Game
                    </button>
                </div>
            </div>

            <div id="game-section" class="hidden">
                <h2>Game in Progress</h2>
                <div id="game-state-label" style="margin-bottom:1rem;font-size:1.2rem;font-weight:500;letter-spacing:0.5px;"></div>
                <div id="hand-area" style="margin: 2rem 0; text-align: center;"></div>
                <div id="trick-area" style="margin: 2rem 0; text-align: center;"></div>
                <!-- <div style="margin-top: 2rem;">
                    <button class="btn" onclick="location.reload()">
                        Return to Lobby
                    </button>
                </div> -->
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        let socket;
        let currentUser = null;
        let mySeat = null;
        let isReady = false;
        let lobbyState = null;

        // Initialize socket connection
        function initializeSocket() {
            console.log('🚀 Initializing Socket.IO connection...');
            console.log('🌍 Connecting to:', window.location.origin);
            console.log('🍪 Document.cookie:', document.cookie);
            
            // Connect using the current path context (within /hearts/)
            socket = io({
                withCredentials: true,
                transports: ['websocket', 'polling'],
                path: '/hearts/socket.io/'
            });

            socket.on('connect', () => {
                console.log('✅ Connected to server successfully');
                console.log('🆔 Socket ID:', socket.id);
                updateConnectionStatus(true);
                socket.emit('join-lobby');
            });

            socket.on('disconnect', (reason) => {
                console.log('❌ Disconnected from server. Reason:', reason);
                updateConnectionStatus(false);
            });

            socket.on('lobby-updated', (data) => {
                console.log('🏠 Lobby updated:', data);
                updateLobbyDisplay(data);
            });

            socket.on('game-started', (data) => {
                console.log('🎮 Game started:', data);
                showGameSection();
            });

            socket.on('cards-dealt', (data) => {
                console.log('🃏 Cards dealt:', data);
                window.currentHand = data.hand;
                console.log('[DEBUG] Initial hand dealt:', JSON.stringify(window.currentHand));
                showHand(data.hand);
            });

            // Listen for game state updates (after passing, etc)
            socket.on('game-state', (data) => {
                console.log('🎲 Game state update:', data);
                lobbyState = data;
                // Only update hand and UI if in 'playing' state, or if in 'passing' state and I haven't passed yet
                let myHand = null;
                let hasPassed = false;
                if (typeof mySeat === 'number' && data.players && data.players[mySeat]) {
                    myHand = data.players[mySeat].hand;
                    // If hand is missing but handSize is 10, assume passed
                    if (!myHand && typeof data.players[mySeat].handSize === 'number' && data.players[mySeat].handSize < 13) {
                        hasPassed = true;
                    }
                }
                if (data.state === 'playing') {
                    // All cards have been passed, update hand
                    if (myHand) {
                        console.log('[DEBUG] Updating hand for seat', mySeat, 'Hand:', JSON.stringify(myHand));
                        window.currentHand = myHand;
                        showHand(myHand);
                    } else {
                        console.log('[DEBUG] No hand found for my seat', mySeat, 'in game-state:', data);
                    }
                    // Show the current trick
                    showTrick(data.currentTrickCards || []);
                    updateGameStateLabel();
                } else if (data.state === 'passing') {
                    // In passing phase
                    if (myHand) {
                        // I haven't passed yet, show my hand
                        window.currentHand = myHand;
                        showHand(myHand);
                    } else if (hasPassed) {
                        // I have passed, keep showing previous hand (do not update)
                        // Optionally, show a waiting message
                        document.getElementById('hand-area').innerHTML += '<div style="margin-top:1rem;color:#ffeb3b;">Waiting for other players to pass cards...</div>';
                    }
                    // Hide trick area in passing phase
                    showTrick([]);
                    // Call updateGameStateLabel after hand is rendered so Pass Cards button is created
                    updateGameStateLabel();
                } else {
                    // Hide trick area in other phases
                    showTrick([]);
                    updateGameStateLabel();
                }
            }); // End socket.on('game-state')
            // Listen for trick-completed event
            socket.on('trick-completed', (data) => {
                // Show the completed trick and highlight the winner
                showTrick(data.trickCards || [], data.winner);
                // Optionally, clear the trick area after a short delay
                setTimeout(() => showTrick([]), 2000);
            });
        // Show the current trick in the trick area
        function showTrick(trickCards, winnerSeat) {
            const trickArea = document.getElementById('trick-area');
            if (!trickArea) return;
            if (!trickCards || trickCards.length === 0) {
                trickArea.innerHTML = '';
                return;
            }
            // Render each card in the trick with player info
            trickArea.innerHTML = '<div style="font-size:1.1rem;margin-bottom:0.5rem;">Current Trick:</div>' +
                '<div style="display:flex;justify-content:center;gap:24px;">' +
                trickCards.map(play => {
                    const highlight = (typeof winnerSeat !== 'undefined' && play.seat === winnerSeat) ? 'box-shadow:0 0 12px 4px #ffeb3b;' : '';
                    return `<div style="text-align:center;">
                        <img src="${getCardImageUrl(play.card)}" alt="${play.card}" title="${play.card}" style="width:60px;height:90px;margin-bottom:6px;border-radius:7px;background:#fff;${highlight}">
                        <div style="font-size:0.95rem;margin-top:2px;">${play.player || 'Player ' + (play.seat+1)}</div>
                    </div>`;
                }).join('') +
                '</div>';
        }

        // Update the game state label in its own element
        function updateGameStateLabel() {
            const labelDiv = document.getElementById('game-state-label');
            const handArea = document.getElementById('hand-area');
            if (!labelDiv || !handArea) return;
            if (lobbyState && lobbyState.state) {
                let stateLabel = '';
                let turnLabel = '';
                switch (lobbyState.state) {
                    case 'passing':
                        stateLabel = 'Passing Round';
                        // Always show Pass Cards button during passing phase
                        let passBtn = document.getElementById('pass-cards-btn');
                        console.log('passBTN: ', passBtn);
                        let hasPassed = false;
                        if (typeof mySeat === 'number' && lobbyState.players && lobbyState.players[mySeat]) {
                            const myPlayer = lobbyState.players[mySeat];
                            if (myPlayer.readyToPass) {
                                hasPassed = true;
                            }
                        }
                        console.log('has passed: ', hasPassed);
                        // Remove and recreate the Pass Cards button every time in passing phase to ensure it is present
                        if (passBtn && passBtn.parentElement) {
                            console.log('passBtn parent element: ', passBtn.parentElement);
                            passBtn.parentElement.remove();
                        }
                        if (!hasPassed) {
                            console.log('[DEBUG] Creating Pass Cards button');
                            const btnDiv = document.createElement('div');
                            btnDiv.style.marginTop = '1.5rem';
                            btnDiv.innerHTML = `<button id="pass-cards-btn" class="btn primary" disabled onclick="passSelectedCards()">Pass Cards</button>`;
                            handArea.appendChild(btnDiv);
                        }
                        passBtn = document.getElementById('pass-cards-btn');
                        // Button is enabled only if 3 cards are selected and user hasn't passed
                        if (passBtn) {
                            passBtn.disabled = hasPassed || !(window.selectedCards && window.selectedCards.length === 3);
                        }
                        // Show waiting message if user has passed
                        let waitMsg = document.getElementById('waiting-pass-msg');
                        if (hasPassed) {
                            if (!waitMsg) {
                                waitMsg = document.createElement('div');
                                waitMsg.id = 'waiting-pass-msg';
                                waitMsg.style.marginTop = '1rem';
                                waitMsg.style.color = '#ffeb3b';
                                waitMsg.textContent = 'Waiting for other players to pass cards...';
                                handArea.appendChild(waitMsg);
                            } else {
                                // Move message to end of handArea if needed
                                handArea.appendChild(waitMsg);
                                waitMsg.style.display = '';
                            }
                        } else if (waitMsg) {
                            waitMsg.style.display = 'none';
                        }
                        break;
                    case 'playing':
                        stateLabel = 'Trick Play';
                        // Remove Pass Cards button if present
                        console.log('BTN REMOVED PLAYING');
                        const passBtnPlay = document.getElementById('pass-cards-btn');
                        if (passBtnPlay && passBtnPlay.parentElement) passBtnPlay.parentElement.remove();
                        // Remove waiting message if present
                        const waitMsgPlay = document.getElementById('waiting-pass-msg');
                        if (waitMsgPlay) waitMsgPlay.remove();
                        // Clear selected cards and update UI when entering playing state
                        window.selectedCards = [];
                        updateCardSelectionUI();
                        // Show whose turn it is
                        if (typeof lobbyState.currentTurnSeat === 'number' && lobbyState.players) {
                            if (mySeat === lobbyState.currentTurnSeat) {
                                turnLabel = '<span style="color:#4caf50;font-weight:bold;">Your turn!</span>';
                            } else {
                                const turnPlayer = lobbyState.players[lobbyState.currentTurnSeat];
                                if (turnPlayer && turnPlayer.userName) {
                                    turnLabel = `${turnPlayer.userName}'s turn`;
                                } else {
                                    turnLabel = `Player ${lobbyState.currentTurnSeat + 1}'s turn`;
                                }
                            }
                        }
                        break;
                    case 'scoring':
                        stateLabel = 'Scoring';
                        // Remove Pass Cards button if present
                        const passBtnScore = document.getElementById('pass-cards-btn');
                        if (passBtnScore && passBtnScore.parentElement) passBtnScore.parentElement.remove();
                        // Remove waiting message if present
                        const waitMsgScore = document.getElementById('waiting-pass-msg');
                        if (waitMsgScore) waitMsgScore.remove();
                        break;
                    default:
                        stateLabel = lobbyState.state.charAt(0).toUpperCase() + lobbyState.state.slice(1);
                        // Remove Pass Cards button if present

                        const passBtnDefault = document.getElementById('pass-cards-btn');
                        if (passBtnDefault && passBtnDefault.parentElement) passBtnDefault.parentElement.remove();
                        // Remove waiting message if present
                        const waitMsgDefault = document.getElementById('waiting-pass-msg');
                        if (waitMsgDefault) waitMsgDefault.remove();
                }
                labelDiv.innerHTML = `Game State: <span style="color:#ffeb3b;">${stateLabel}</span>` + (turnLabel ? ` &mdash; <span style="color:#fff;">${turnLabel}</span>` : '');
            } else {
                labelDiv.innerHTML = '';
                // Remove Pass Cards button if present
                const passBtn = document.getElementById('pass-cards-btn');
                if (passBtn && passBtn.parentElement) passBtn.parentElement.remove();
                // Remove waiting message if present
                const waitMsg = document.getElementById('waiting-pass-msg');
                if (waitMsg) waitMsg.remove();
            }
        }

        // Map card code (e.g. 'QS') to local SVG in bridge3-box-qr-Large
        function getCardImageUrl(cardCode) {
            if (!cardCode || cardCode.length < 2) return '';
            // Normalize 10s: 'T' or '10' to 'T'
            let rank = cardCode[0];
            let suit = cardCode[1];
            if (rank === '1' && cardCode[1] === '0') { rank = 'T'; suit = cardCode[2]; }
            // Map to file: e.g. 'QS' => 'QS.svg', 'TH' => 'TH.svg', etc.
            // All files are uppercase, so ensure uppercase
            const fileName = (rank + suit).toUpperCase() + '.svg';
            // https://kl-pi.tail9f5728.ts.net/hearts/bridge3-box-qr-Large/6C.svg
            return `/hearts/bridge3-box-qr-Large/${fileName}`;
        }

        // Show the player's hand as card images
        function showHand(hand) {
            const handArea = document.getElementById('hand-area');
            if (!handArea) return;
            // If in passing phase and user has already passed (no hand), do NOT clear hand area or remove Pass Cards button
            if ((!hand || !Array.isArray(hand)) && lobbyState && lobbyState.state === 'passing') {
                // Just return, keep previous hand/cards and Pass Cards button/waiting message
                console.log('[DEBUG] showHand called with no hand during passing phase, keeping UI.');
                return;
            }
            if (!hand || !Array.isArray(hand)) {
                handArea.innerHTML = '<em>No cards dealt.</em>';
                console.log('[DEBUG] showHand called with no hand:', hand);
                return;
            }

            // Debug: show previous and current phase
            if (!window._lastPhase) window._lastPhase = null;
            const currentPhase = lobbyState ? lobbyState.state : null;
            if (!window.selectedCards) window.selectedCards = [];
            if (window._lastPhase !== currentPhase) {
                console.log('[DEBUG] Phase changed from', window._lastPhase, 'to', currentPhase);
                // Only clear selection if entering playing phase
                if (currentPhase === 'playing') {
                    window.selectedCards = [];
                }
                // Optionally, clear on entering passing phase too
                if (currentPhase === 'passing') {
                    window.selectedCards = [];
                }
                window._lastPhase = currentPhase;
            }

            // Only render hand cards (no game state label or pass button)
            handArea.innerHTML = '<div id="hand-cards"></div>';
            const handCardsDiv = document.getElementById('hand-cards');
            handCardsDiv.innerHTML = hand.map(card => {
                // Always allow toggleCard in passing phase, playCard in playing phase and your turn
                if (lobbyState && lobbyState.state === 'passing') {
                    // onclick="window.toggleCard('${card}'
                return `<img src="${getCardImageUrl(card)}" alt="${card}" title="${card}" data-card="${card}" class="card-img" style="width:70px;height:100px;margin:0 6px;vertical-align:middle;box-shadow:0 2px 8px #0003;border-radius:8px;background:#fff;outline:none;cursor:pointer;" onclick="window.toggleCard('${card}')">`;
                } else if (lobbyState && lobbyState.state === 'playing' && typeof mySeat === 'number' && mySeat === lobbyState.currentTurnSeat) {
                    // onclick="window.playCard('${card}')
                    return `<img src="${getCardImageUrl(card)}" alt="${card}" title="${card}" data-card="${card}" class="card-img" style="width:70px;height:100px;margin:0 6px;vertical-align:middle;box-shadow:0 2px 8px #0003;border-radius:8px;background:#fff;outline:none;cursor:pointer;" onclick="window.playCard('${card}')">`;
                } else {
                    // onclick="window.toggleCard('${card}'
                    return `<img src="${getCardImageUrl(card)}" alt="${card}" title="${card}" data-card="${card}" class="card-img" style="width:70px;height:100px;margin:0 6px;vertical-align:middle;box-shadow:0 2px 8px #0003;border-radius:8px;background:#fff;outline:none;cursor:pointer;" onclick="window.toggleCard('${card}')">`;   
                }
            }).join('');
            console.log('[DEBUG] showHand rendered hand:', JSON.stringify(hand));
            // Update selection UI
            updateCardSelectionUI();

// Play a card (only allowed if it's your turn and in playing state)
window.playCard = function(card) {
    if (!lobbyState || lobbyState.state !== 'playing' || typeof mySeat !== 'number' || mySeat !== lobbyState.currentTurnSeat) {
        return;
    }
    // Prevent double-clicks
    const handCardsDiv = document.getElementById('hand-cards');
    if (handCardsDiv) {
        Array.from(handCardsDiv.children).forEach(img => {
            img.style.pointerEvents = 'none';
        });
    }

    // Use HTTP POST to /hearts/play-card instead of socket.emit
    fetch('/hearts/play-card', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        credentials: 'include',
        body: JSON.stringify({ card })
    })
    .then(async (res) => {
        // console.log('[DEBUG] playCard response:', res);
        const data = await res.json().catch(() => ({}));
        if (!res.ok || !data.success) {
            // Show error and re-enable pointer events
            showErrorMessage(data.error || 'Invalid card or server error');
            const handCardsDiv = document.getElementById('hand-cards');
            if (handCardsDiv) {
                Array.from(handCardsDiv.children).forEach(img => {
                    img.style.pointerEvents = 'auto';
                });
            }
            return;
        }
        // Success: do nothing, wait for game-state update from server
    })
    .catch((err) => {
        showErrorMessage('Network/server error');
        const handCardsDiv = document.getElementById('hand-cards');
        if (handCardsDiv) {
            Array.from(handCardsDiv.children).forEach(img => {
                img.style.pointerEvents = 'auto';
            });
        }
    });
};
        } // End showHand

        // Update card selection UI only (no re-render of SVGs)
        function updateCardSelectionUI() {
            const hand = window.currentHand || [];
            const handCardsDiv = document.getElementById('hand-cards');
            if (!handCardsDiv) return;
            Array.from(handCardsDiv.children).forEach((img, idx) => {
                const card = hand[idx];
                if (window.selectedCards.includes(card)) {
                    img.classList.add('selected');
                    img.style.outline = '3px solid #ffeb3b';
                } else {
                    img.classList.remove('selected');
                    img.style.outline = 'none';
                }
            });
            updatePassButton();
        }

        // Make toggleCard globally accessible for inline onclick
window.toggleCard = function(card) {
    // Only allow selection in 'passing' state
    if (!lobbyState || lobbyState.state !== 'passing') {
        console.log('[DEBUG] toggleCard: not in passing phase, ignoring click');
        return;
    }
    console.log('[DEBUG] toggleCard: clicked', card, 'selectedCards before:', window.selectedCards.slice());
    const idx = window.selectedCards.indexOf(card);
    if (idx === -1) {
        if (window.selectedCards.length < 3) {
            window.selectedCards.push(card);
            console.log('[DEBUG] toggleCard: added', card, 'selectedCards now:', window.selectedCards.slice());
        } else {
            console.log('[DEBUG] toggleCard: already 3 selected, ignoring');
        }
    } else {
        window.selectedCards.splice(idx, 1);
        console.log('[DEBUG] toggleCard: removed', card, 'selectedCards now:', window.selectedCards.slice());
    }
    updateCardSelectionUI();
};

        // Remove toggleCardHandler, now using window.toggleCard directly

        // Enable/disable Pass Cards button
        function updatePassButton() {
            const btn = document.getElementById('pass-cards-btn');
            if (!btn) return;
            btn.disabled = !(window.selectedCards && window.selectedCards.length === 3);
        }

        // Pass selected cards to server
window.passSelectedCards = function() {
    if (!window.selectedCards || window.selectedCards.length !== 3) return;
    // Only notify backend that user is ready to pass (do not send cards)
    console.log('[DEBUG] Marking ready to pass (sending cards)');
    console.log(window.selectedCards)
    socket.emit('pass-cards', {cards: window.selectedCards});
    const btn = document.getElementById('pass-cards-btn');
    if (!btn) return;
    btn.disabled = true;

};

            socket.on('ready-to-start', (data) => {
                showSuccessMessage(data.message);
            });

            socket.on('error', (data) => {
                console.error('❌ Socket error:', data);
                showErrorMessage(data.message);
            });

            socket.on('connect_error', (error) => {
                console.error('🔥 Connection error:', error);
                console.error('🔍 Error type:', error.type);
                console.error('📝 Error description:', error.description);
                console.error('📋 Error data:', error.data);
                updateConnectionStatus(false);
                showErrorMessage('Connection failed: ' + (error.description || error.message || 'Unknown error'));
            });

            // Debug transport events
            socket.on('disconnect', (reason, details) => {
                console.log('🔌 Disconnect reason:', reason);
                console.log('🔍 Disconnect details:', details);
            });
            
            socket.io.on('error', (error) => {
                console.error('🚨 Socket.IO error:', error);
            });
        }

        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connection-status');
            if (connected) {
                statusEl.textContent = 'Connected';
                statusEl.className = 'connection-status connected';
            } else {
                statusEl.textContent = 'Disconnected';
                statusEl.className = 'connection-status disconnected';
            }
        }

        function updateLobbyDisplay(state) {
            lobbyState = state;
            

            // Count real and dummy players for player count and readiness
            let playerCount = 0;
            let readyCount = 0;
            let allReady = true;
            for (let seat = 0; seat < 4; seat++) {
                let player = state.players[seat];
                if (!player && (seat === 2 || seat === 3)) {
                    player = {
                        userId: `dummy${seat}`,
                        userName: seat === 2 ? 'TestBot A' : 'TestBot B',
                        isReady: true,
                        isConnected: true,
                        isBot: true
                    };
                }
                if (player) {
                    playerCount++;
                    if (player.isReady && player.isConnected) {
                        readyCount++;
                    } else {
                        allReady = false;
                    }
                } else {
                    allReady = false;
                }
            }
            document.getElementById('player-count').textContent = playerCount;


            // Update lobby leader
            let leaderName = 'None';
            if (state.lobbyLeader !== null && state.players[state.lobbyLeader]) {
                leaderName = state.players[state.lobbyLeader].userName;
            }
            document.getElementById('lobby-leader').textContent = leaderName;

            // Patch canStartGame if only dummy bots are missing
            // (so Start Game button is enabled for 2 real + 2 dummy)
            if (playerCount === 4 && readyCount === 4) {
                state.canStartGame = true;
            }

            // Update seats
            const seatClassMap = ['seat-upper', 'seat-left', 'seat-right', 'seat-lower'];
            for (let seat = 0; seat < 4; seat++) {
                const seatEl = document.querySelector(`[data-seat="${seat}"]`);
                let player = state.players[seat];
                // Inject dummy users for seats 2 and 3 (seat 2 = index 2, seat 3 = index 3) if empty
                if (!player && (seat === 2 || seat === 3)) {
                    player = {
                        userId: `dummy${seat}`,
                        userName: seat === 2 ? 'TestBot A' : 'TestBot B',
                        isReady: true,
                        isConnected: true,
                        isBot: true
                    };
                }
                seatEl.className = `seat ${seatClassMap[seat]}`;
                if (player) {
                    seatEl.classList.add('occupied');
                    // Check if this is my seat
                    const isMySeat = player.userId === currentUser?.id;
                    if (isMySeat) {
                        seatEl.classList.add('my-seat');
                        mySeat = seat;
                        isReady = player.isReady;
                    }
                    // Add leave seat option for my seat when not ready
                    const leaveOption = isMySeat && !player.isReady ? 
                        `<div class="seat-leave" onclick="leaveSeat()" style="margin-top: 0.5rem;">
                            <small style="color: #ff9800; cursor: pointer; text-decoration: underline;">Leave Seat</small>
                         </div>` : '';
                    seatEl.innerHTML = `
                        <div class="seat-number">Seat ${seat + 1}</div>
                        <div class="seat-content">
                            <div class="seat-player">${player.userName}</div>
                            <div class="seat-status ${player.isReady ? 'ready' : 'not-ready'}">
                                ${player.isReady ? 'Ready' : 'Not Ready'}
                            </div>
                            ${leaveOption}
                        </div>
                    `;
                } else {
                    seatEl.innerHTML = `
                        <div class="seat-number">Seat ${seat + 1}</div>
                        <div class="seat-content">
                            <div class="empty-seat">Click to sit</div>
                        </div>
                    `;
                }
            }

            // Update controls
            updateControls();
        }

        function updateControls() {
            const leaveSeatBtn = document.getElementById('leave-seat-btn');
            const readyBtn = document.getElementById('ready-btn');
            const startGameBtn = document.getElementById('start-game-btn');

            // Show/hide buttons based on seat status
            if (mySeat !== null) {
                leaveSeatBtn.classList.remove('hidden');
                readyBtn.classList.remove('hidden');
                readyBtn.textContent = isReady ? 'Not Ready' : 'Ready for Game';
                readyBtn.className = isReady ? 'btn danger' : 'btn primary';
            } else {
                leaveSeatBtn.classList.add('hidden');
                readyBtn.classList.add('hidden');
            }

            // Show start game button for lobby leader when all ready
            if (lobbyState?.canStartGame && mySeat === lobbyState?.lobbyLeader) {
                startGameBtn.classList.remove('hidden');
            } else {
                startGameBtn.classList.add('hidden');
            }
        }

        function handleSeatClick(seat) {
            if (!socket || !socket.connected) {
                showErrorMessage('Not connected to server');
                return;
            }

            // If seat is occupied, do nothing
            if (lobbyState?.players[seat]) {
                return;
            }

            // If I already have a seat, do nothing
            if (mySeat !== null) {
                showErrorMessage('You already have a seat. Leave your current seat first.');
                return;
            }

            socket.emit('take-seat', { seat: seat });
        }

        function leaveSeat() {
            if (!socket || !socket.connected) {
                showErrorMessage('Not connected to server');
                return;
            }

            socket.emit('leave-seat');
            mySeat = null;
            isReady = false;
        }

        function toggleReady() {
            if (!socket || !socket.connected) {
                showErrorMessage('Not connected to server');
                return;
            }

            if (mySeat === null) {
                showErrorMessage('You must take a seat first');
                return;
            }

            socket.emit('ready-for-game');
        }

        function startGame() {
            if (!socket || !socket.connected) {
                showErrorMessage('Not connected to server');
                return;
            }

            if (!lobbyState?.canStartGame) {
                showErrorMessage('Not all players are ready');
                return;
            }

            socket.emit('start-game');
        }

        function showGameSection() {
            document.getElementById('lobby-section').classList.add('hidden');
            document.getElementById('game-section').classList.remove('hidden');
        }

        function showErrorMessage(message) {
            const container = document.getElementById('error-container');
            container.innerHTML = `<div class="error-message">${message}</div>`;
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }

        function showSuccessMessage(message) {
            const container = document.getElementById('success-container');
            container.innerHTML = `<div class="success-message">${message}</div>`;
            setTimeout(() => {
                container.innerHTML = '';
            }, 3000);
        }

        // Get user info from server
        async function getCurrentUser() {
            try {
                const response = await fetch('/api/user');
                const data = await response.json();
                if (data.authenticated && data.user) {
                    currentUser = data.user;
                    document.getElementById('user-name').textContent = data.user.name;
                    console.log('👤 Current user:', currentUser);
                    return data.user;
                }
            } catch (error) {
                console.error('Error fetching user info:', error);
            }
            
            // Fallback - should not happen if authentication is working
            const fallbackUser = {
                id: 1,
                name: 'Unknown User'
            };
            currentUser = fallbackUser;
            document.getElementById('user-name').textContent = fallbackUser.name;
            return fallbackUser;
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await getCurrentUser();
            } catch (error) {
                console.error('Failed to get user info:', error);
                // Continue with fallback user
            }
            initializeSocket();
        });
    </script>
</body>
</html>
